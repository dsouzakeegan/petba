<!-- chat.page.html -->

<ion-toolbar  > <!-- You can use any shade of blue by changing the hex code style="--background: #007bff;"-->
  <!-- Back Button to return to the previous page -->
    <ion-buttons slot="start">
      <ion-back-button icon="arrow-back"></ion-back-button>
    </ion-buttons>
  <!-- Displaying the pet image and name along with the owner's name -->
    <ion-header [translucent]="true" class="custom-header-2" style="margin-top: 5px;">
      <ion-item style="--background:transparent;" lines="none">
        <ion-avatar slot="start">
          <img alt="Pet Image" [src]="pfp" (error)="pfp = 'https://ionicframework.com/docs/img/demos/avatar.svg'" />
        </ion-avatar>
        <ion-title style="margin-left: -21px;">
          {{ petName }} â—¦ {{ ownerName }}
          <!-- Typing indicator just below the pet and owner names -->
          <div *ngIf="isTyping" class="typing-indicator" style="margin-top: -5px;">
            <ion-text color="medium" style="font-size: medium;">
              <span>typing</span><span class="dot dot-1">.</span><span class="dot dot-2">.</span><span class="dot dot-3">.</span>
            </ion-text>
          </div>
        </ion-title>
      </ion-item>
  </ion-header>
  </ion-toolbar>
  
  <div style="padding: top 20px ;"> "   "</div>
  
  <ion-content [fullscreen]="true">
    <!-- Collapsing header on scroll -->
    <ion-header collapse="condense">
      <ion-toolbar>
        <ion-title size="large">Chat</ion-title>
      </ion-toolbar>
    </ion-header>
  
    <!-- Chat messages grid -->
    <ion-grid [fixed]="true" *ngIf="(chats | async) as chat$">
      <ion-row class="ion-padding-horizontal" *ngFor="let msg of chat$" [ngClass]="userId == msg.senderId ? 'message-right' : 'message-left'">
    
        <!-- Text messages -->
        <div class="message-text" *ngIf="msg.type === 'message'">
          <div>
            <p class="message">{{ msg.message }}</p>
            <!-- Blue tick for seen messages -->
            <ion-icon *ngIf="msg.seen" name="checkmark-done-outline" color="primary"></ion-icon>
          </div>
          <ion-note class="msg-time">{{ msg.time | date: 'shortTime' }}</ion-note>
        </div>
    
        <!-- Image messages -->
        <div class="message-text message-img" *ngIf="msg.type === 'img'">
          <div style="display: inline-block;">
            <ion-img *ngIf="msg.img" [src]="msg.img" [routerLink]="['/image-view']" [state]="{ img: [msg.img] }" (ionError)="msg.img = ''"></ion-img>
            <ion-note class="deleted-msg" *ngIf="!msg.img">Image not found <ion-icon name="warning-outline"></ion-icon></ion-note>
            <ion-button *ngIf="msg.img" (click)="downloadImage(msg.img)" fill="clear" color="primary">
              <ion-icon name="download-outline" slot="icon-only"></ion-icon>
            </ion-button>
            <!-- Blue tick for seen images -->
            <ion-icon *ngIf="msg.seen" name="checkmark-done-outline" color="primary"></ion-icon>
          </div>
          <ion-note class="msg-time">{{ msg.time | date: 'shortTime' }}</ion-note>
        </div>
      </ion-row>
    </ion-grid>  
  
  </ion-content>
  
  <!-- Input Field -->
  <ion-footer>
    <ion-toolbar class="input" slot="start" style="padding-bottom: 10px;">
      <ion-item color="light">
        <!-- Camera and Share buttons, only show when there is no message text -->
        <ion-buttons slot="start" *ngIf="!msg.message">
          <!-- Camera Button -->
          <ion-button (click)="sendImage()" fill="solid" color="primary">
            <ion-icon name="camera-sharp" slot="icon-only"></ion-icon>
          </ion-button>
          <!-- Share Button -->
          <!-- <ion-button (click)="shareContent()" fill="solid" color="primary">
            <ion-icon name="share-social-outline" slot="icon-only"></ion-icon>
          </ion-button> -->
        </ion-buttons>
        <!-- Textarea for composing a message -->
        <ion-textarea [(ngModel)]="msg.message" 
                      (ionInput)="onType()" 
                      (ionBlur)="onStopTyping()" 
                      [autoGrow]="true" 
                      class="message-input" 
                      [rows]="1" 
                      placeholder="Send message">
        </ion-textarea>
      </ion-item>
    </ion-toolbar>
  
    <!-- Send button, disabled when the message is empty -->
    <ion-toolbar class="send" style="padding-bottom: 10px;">
      <ion-buttons>
        <ion-button (click)="sendmsg()" shape="round" color="primary" fill="solid" [disabled]="!msg.message.trim()">
          <ion-icon name="send" slot="icon-only"></ion-icon>
        </ion-button>
      </ion-buttons>
    </ion-toolbar>
  </ion-footer>
  
  <style>
    .message {
      word-wrap: break-word; /* This ensures that long words break onto the next line */
      white-space: pre-wrap; /* Preserves spaces and breaks lines where necessary */
      overflow-wrap: break-word; /* Additional property for better browser support */
      word-break: break-word; /* Ensures words break appropriately */
      margin: 0; /* Remove margin to prevent unnecessary spacing */
      padding: 10px; /* Add some padding for better readability */
      border-radius: 10px; /* Optional: Add border radius for rounded message bubbles */
      background-color: #f1f1f1; /* Optional: Background color for message bubbles */
    }
  </style>
  